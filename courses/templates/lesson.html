{% extends 'base.html' %}
{% load video_filters %}

{% block title %}{{ lesson.title }} - OnlineTest{% endblock %}

{% block extra_css %}
<style>
    .back-link {
        display: inline-block;
        color: #3498db;
        text-decoration: none;
        margin-bottom: 20px;
        padding: 8px 15px;
        background: #ecf0f1;
        border-radius: 5px;
        transition: background 0.3s;
    }
    .back-link:hover {
        background: #bdc3c7;
    }
    .lesson-header {
        margin-bottom: 25px;
        border-bottom: 2px solid #3498db;
        padding-bottom: 15px;
    }
    .lesson-title {
        font-size: 2em;
        color: #2c3e50;
        margin-bottom: 8px;
    }
    .lesson-meta {
        color: #7f8c8d;
        font-size: 0.95em;
    }
    .video-container {
        margin-bottom: 25px;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        background: #000;
    }
    .video-container iframe {
        width: 100%;
        height: 480px;
        border: none;
        display: block;
    }
    .video-container video {
        width: 100%;
        display: block;
    }
    .lesson-content {
        line-height: 1.8;
        color: #34495e;
        font-size: 1.05em;
        margin-bottom: 25px;
    }
    .lesson-content p {
        margin-bottom: 15px;
    }
    .test-section {
        background: linear-gradient(135deg, #3498db, #2c3e50);
        color: white;
        padding: 25px;
        border-radius: 8px;
        text-align: center;
    }
    .test-section h3 {
        font-size: 1.4em;
        margin-bottom: 10px;
    }
    .test-section p {
        margin-bottom: 15px;
        opacity: 0.9;
    }
    .test-btn {
        display: inline-block;
        padding: 12px 30px;
        background: white;
        color: #3498db;
        text-decoration: none;
        border-radius: 25px;
        font-weight: bold;
        transition: transform 0.3s, box-shadow 0.3s;
    }
    .test-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    .youtube-fallback-link {
        text-align: center;
    }
    .youtube-fallback-link a {
        color: #e53935;
        font-weight: 600;
        text-decoration: none;
    }
    .youtube-fallback-link a:hover {
        text-decoration: underline;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <a href="javascript:history.back()" class="back-link">← Назад к урокам</a>

    <div class="lesson-header">
        <h1 class="lesson-title">{{ lesson.title }}</h1>
        <p class="lesson-meta">Модуль: {{ lesson.module.name }}</p>
    </div>

    {% if lesson.video_url %}
    <div class="video-container">
        {% if lesson.video_url|is_youtube %}
            {% with video_id=lesson.video_url|youtube_id %}
                {% if video_id %}
                <iframe
                    width="100%"
                    height="480"
                    src="{{ video_id|youtube_embed_url }}"
                    title="YouTube video player"
                    frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                    referrerpolicy="strict-origin-when-cross-origin"
                    allowfullscreen>
                </iframe>
                <div class="youtube-fallback-link">
                    <a href="https://www.youtube.com/watch?v={{ video_id }}" target="_blank" rel="noopener noreferrer"></a>
                </div>
                {% else %}
                <p style="color: red; padding: 20px;">Ошибка: неверный формат YouTube URL</p>
                {% endif %}
            {% endwith %}
        {% else %}
        <video controls>
            <source src="{{ lesson.video_url }}" type="video/mp4">
            Ваш браузер не поддерживает видео.
        </video>
        {% endif %}
    </div>
    {% endif %}

    <div class="lesson-content">
        {{ lesson.content|linebreaks }}
    </div>

    {% if lesson.has_test %}
    <div class="test-section">
        <h3>Тест по уроку</h3>
        <p>Проверьте свои знания, ответив на вопросы теста</p>
        <a href="{% url 'tests_app:lesson_test' lesson.id 1 %}" class="test-btn">Начать тест →</a>
    </div>
    {% else %}
    <div class="test-section">
        <h3>Урок завершен</h3>
        <p>Если вы изучили материал, отметьте урок как завершенный</p>
        <a href="{% url 'progress:complete_lesson' lesson.id %}" class="test-btn">Завершить урок →</a>
    </div>
    {% endif %}
</div>
{% endblock %}