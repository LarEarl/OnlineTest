{% extends 'base.html' %}
{% block title %}Редактировать тест{% endblock %}
{% block content %}
<div class="container">
  <h1>Редактирование теста: {{ test.title }}</h1>
  
  <form method="post" style="margin-top:15px; background:#f8f9fa; padding:20px; border-radius:8px;">
    {% csrf_token %}
    <input type="hidden" name="action" value="edit_test">
    {{ form.non_field_errors }}
    <div>{{ form.lesson.label_tag }}{{ form.lesson }}</div>
    <div>{{ form.title.label_tag }}{{ form.title }}</div>
    <div>{{ form.description.label_tag }}{{ form.description }}</div>
    <button type="submit">Сохранить</button>
    <a href="{% url 'teacher_app:tests' %}" style="margin-left:10px;">Отмена</a>
  </form>

  <div style="margin-top:30px;">
    <h2>Вопросы теста ({{ questions.count }})</h2>
    {% if questions %}
      <div style="display:flex;flex-direction:column;gap:20px;margin-top:15px;">
        {% for question in questions %}
        <div style="background:#fff;border-radius:8px;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,0.08);border-left:4px solid {% if question.is_code %}#e74c3c{% else %}#3498db{% endif %};">
          <form method="post" style="margin-bottom:15px;">
            {% csrf_token %}
            <input type="hidden" name="action" value="edit_question">
            <input type="hidden" name="question_id" value="{{ question.id }}">
            
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px;">
              <div style="flex:1;">
                <span style="background:{% if question.is_code %}#e74c3c{% else %}#3498db{% endif %};color:#fff;padding:4px 10px;border-radius:4px;font-size:0.85em;font-weight:bold;">
                  {% if question.is_code %}CODE{% else %}QUIZ{% endif %}
                </span>
                <input type="number" name="order" value="{{ question.order }}" min="1" style="width:60px;margin-left:8px;padding:4px 8px;border:1px solid #ddd;border-radius:4px;">
              </div>
              <div style="display:flex;gap:5px;">
                <a href="{% url 'teacher_app:question_move' question.pk 'up' %}" style="padding:5px 10px;background:#3498db;color:#fff;border-radius:4px;text-decoration:none;font-size:0.85em;">Вверх</a>
                <a href="{% url 'teacher_app:question_move' question.pk 'down' %}" style="padding:5px 10px;background:#3498db;color:#fff;border-radius:4px;text-decoration:none;font-size:0.85em;">Вниз</a>
                <button type="submit" style="padding:5px 10px;background:#27ae60;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:0.85em;">Сохранить</button>
                <button type="submit" name="action" value="delete_question" onclick="return confirm('Удалить этот вопрос?')" style="padding:5px 10px;background:#e74c3c;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:0.85em;">Удалить</button>
              </div>
            </div>
            
            <textarea name="text" rows="3" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;font-size:1em;resize:vertical;">{{ question.text }}</textarea>
          </form>

          {% if not question.is_code %}
            <div style="margin-top:12px;padding:12px;background:#f8f9fa;border-radius:6px;">
              <h4 style="color:#7f8c8d;font-size:0.9em;margin-bottom:8px;">Варианты ответов:</h4>
              {% for option in question.options.all %}
                <form method="post" style="padding:8px;margin:5px 0;background:{% if option.is_correct %}#d5f4e6{% else %}#fff{% endif %};border:1px solid {% if option.is_correct %}#27ae60{% else %}#ddd{% endif %};border-radius:4px;display:flex;align-items:center;gap:10px;">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="edit_option">
                  <input type="hidden" name="option_id" value="{{ option.id }}">
                  
                  <input type="checkbox" name="is_correct" {% if option.is_correct %}checked{% endif %} style="width:20px;height:20px;">
                  <input type="text" name="text" value="{{ option.text }}" style="flex:1;padding:6px;border:1px solid #ddd;border-radius:4px;">
                  <button type="submit" style="padding:4px 8px;background:#27ae60;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:0.8em;">Сохр.</button>
                  <button type="submit" name="action" value="delete_option" onclick="return confirm('Удалить ответ?')" style="padding:4px 8px;background:#e74c3c;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:0.8em;">Удал.</button>
                </form>
              {% empty %}
                <p style="color:#e74c3c;font-size:0.9em;">Нет вариантов ответов</p>
              {% endfor %}
            </div>
          {% else %}
            <div style="margin-top:12px;padding:12px;background:#fef5e7;border-radius:6px;border:1px solid #f39c12;">
              <h4 style="color:#d68910;font-size:0.9em;margin-bottom:10px;">Тест-кейсы для проверки кода:</h4>
              {% for test_case in question.code_cases.all %}
                <form method="post" style="padding:10px;margin:8px 0;background:#fff;border:1px solid #f39c12;border-radius:4px;">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="edit_test_case">
                  <input type="hidden" name="test_case_id" value="{{ test_case.id }}">
                  
                  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:8px;">
                    <div>
                      <label style="font-size:0.85em;color:#7f8c8d;display:block;margin-bottom:4px;">Входные данные (stdin):</label>
                      <textarea name="input_data" rows="2" style="width:100%;padding:6px;border:1px solid #ddd;border-radius:4px;font-family:monospace;font-size:0.9em;">{{ test_case.input_data }}</textarea>
                    </div>
                    <div>
                      <label style="font-size:0.85em;color:#7f8c8d;display:block;margin-bottom:4px;">Ожидаемый вывод (stdout):</label>
                      <textarea name="expected_output" rows="2" style="width:100%;padding:6px;border:1px solid #ddd;border-radius:4px;font-family:monospace;font-size:0.9em;">{{ test_case.expected_output }}</textarea>
                    </div>
                  </div>
                  
                  <div style="display:flex;justify-content:space-between;align-items:center;">
                    <div>
                      <label style="font-size:0.85em;color:#7f8c8d;margin-right:6px;">Лимит времени:</label>
                      <input type="number" name="time_limit" value="{{ test_case.time_limit }}" step="0.1" min="0.1" style="width:80px;padding:4px;border:1px solid #ddd;border-radius:4px;">
                      <span style="font-size:0.85em;color:#7f8c8d;margin-left:4px;">сек</span>
                    </div>
                    <div style="display:flex;gap:5px;">
                      <button type="submit" style="padding:4px 10px;background:#27ae60;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:0.85em;">Сохранить</button>
                      <button type="submit" name="action" value="delete_test_case" onclick="return confirm('Удалить тест-кейс?')" style="padding:4px 10px;background:#e74c3c;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:0.85em;">Удалить</button>
                    </div>
                  </div>
                </form>
              {% empty %}
                <p style="color:#e67e22;font-size:0.85em;margin:8px 0;">Тест-кейсов пока нет</p>
              {% endfor %}
              
              <form method="post" style="margin-top:12px;padding:10px;background:#fff;border:2px dashed #f39c12;border-radius:4px;">
                {% csrf_token %}
                <input type="hidden" name="action" value="add_test_case">
                <input type="hidden" name="question_id" value="{{ question.id }}">
                <h5 style="color:#e67e22;font-size:0.9em;margin-bottom:8px;">Добавить новый тест-кейс:</h5>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:8px;">
                  <div>
                    <label style="font-size:0.85em;color:#7f8c8d;display:block;margin-bottom:4px;">Входные данные:</label>
                    <textarea name="input_data" rows="2" placeholder="5&#10;10" style="width:100%;padding:6px;border:1px solid #ddd;border-radius:4px;font-family:monospace;font-size:0.9em;"></textarea>
                  </div>
                  <div>
                    <label style="font-size:0.85em;color:#7f8c8d;display:block;margin-bottom:4px;">Ожидаемый вывод:</label>
                    <textarea name="expected_output" rows="2" placeholder="15" style="width:100%;padding:6px;border:1px solid #ddd;border-radius:4px;font-family:monospace;font-size:0.9em;"></textarea>
                  </div>
                </div>
                
                <div style="display:flex;justify-content:space-between;align-items:center;">
                  <div>
                    <label style="font-size:0.85em;color:#7f8c8d;margin-right:6px;">Лимит времени:</label>
                    <input type="number" name="time_limit" value="1.0" step="0.1" min="0.1" style="width:80px;padding:4px;border:1px solid #ddd;border-radius:4px;">
                    <span style="font-size:0.85em;color:#7f8c8d;margin-left:4px;">сек</span>
                  </div>
                  <button type="submit" style="padding:6px 15px;background:#e67e22;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:0.85em;font-weight:bold;">+ Добавить тест-кейс</button>
                </div>
              </form>
            </div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    {% else %}
      <div style="background:#fff;border-radius:8px;padding:30px;text-align:center;margin-top:15px;box-shadow:0 2px 10px rgba(0,0,0,0.08);">
        <p style="color:#95a5a6;font-size:1.1em;">Вопросов пока нет</p>
        <p style="color:#7f8c8d;font-size:0.95em;margin-top:8px;">Добавьте вопросы через страницу "Управление тестами"</p>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}
